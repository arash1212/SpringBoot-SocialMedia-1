<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <div th:if="${session.userDetail!=null}">
        <title>پروفایل</title>
    </div>
    <div th:if="${session.userDetail!=null}">
        <title>خطا</title>
    </div>

</head>
<body dir="rtl">

<ul>
    <li><a href="/">صفحه اصلی</a></li>
    <!--add these to list only if user is not authorized-->
    <div sec:authorize="isAnonymous()">
        <li><a href="/signup">ثبت نام</a></li>
        <li><a href="/login">ورود به سایت</a></li>
    </div>
    <!--add these to list only if user is authorized-->
    <div sec:authorize="isAuthenticated()">
        <li><a href="/user/friendRequest">درخواست های دوستی (تست)</a></li>
        <li><a href="/logout">خروج</a></li>
    </div>
</ul>
<br/>

<div th:if="${session.userDetail!=null}">
    <h2 th:text="'پروفایل کاربر :' + ${session.userDetail.getUsername()} " style="margin: auto"></h2>
</div>

<!--friend Request form-only shows up if user is not in it's own profile-->
<div th:if="${session.userDetail!=null&&session.userDetail.getId()!=session.authenticatedUserId}">

    <!--if user have already sent a friend request to this user-->
    <div th:if="${session.friendRequestState.equals('requestSender')}">
        <form action="/user/sendFriendRequest.do">
            <input type="text" name="authenticatedUserID" th:value="${session.authenticatedUserId}" readonly
                   hidden/><br/>
            <input type="text" name="userId" th:value="${param.id}" readonly hidden/><br/>
            <input type="text" value="شما قبلا درخواست دوستی ارسال کرده اید"/>
        </form>
    </div>

    <!--if user have already received a friend request from this user-->
    <div th:if="${session.friendRequestState.equals('requestReceiver')}">
        <form action="/user/friendRequest">
            <input type="text" name="authenticatedUserID" th:value="${session.authenticatedUserId}" readonly
                   hidden/><br/>
            <input type="text" name="userId" th:value="${param.id}" readonly hidden/><br/>
            <input type="submit" value="شما قبلا از این کاربر درخواست دوستی دریافت کرده اید.برای بررسی کلیک کنید"/>
        </form>
    </div>

    <!--if user dont have any friend request from this user or doesn't created any request to this user-->
    <div th:if="${session.friendRequestState.equals('none')}">
        <form action="/user/sendFriendRequest.do">
            <input type="text" name="authenticatedUserID" th:value="${session.authenticatedUserId}" readonly
                   hidden/><br/>
            <input type="text" name="userId" th:value="${param.id}" readonly hidden/><br/>
            <input type="submit" value="ارسال درخواست دوستی"/>
        </form>
    </div>
</div>


<div th:if="${param.id!=null}">

    <!--show 'send post' form only if user is in it's own profile-->
    <div th:if="${session.userDetail!=null&&session.userDetail.getUsername().equals(#authentication.name)}"
         style="margin:auto; width: 40%;height: fit-content;border: none;">
        <fieldset>
            <legend><h3>ثبت پست جدید</h3></legend>
            <form action="/user/sendPost.do" method="post" enctype="multipart/form-data">
                <input type="text" name="userId" th:value="${param.id}" readonly hidden><br/>
                <label for="textInput">متن پست :</label><br/><br/>
                <textarea id="textInput" name="text" placeholder="متن مورد نظر را در اینجا تایپ کنید..." required
                          style="width: 50%;height: 100px;resize: none"></textarea><br/><br/><br/>
                <label for="filePosted">تصویر یا ویدیو (حداکثر حجم ۵۰۰ مگابایت) :</label><br/><br/>
                <input id="filePosted" type="file" name="filePosted"><br/>
                <br/>
                <input type="submit" value="ثبت پست">
                <br/>
            </form>
        </fieldset>
    </div>


    <div th:if="${session.userDetail!=null}" style="margin:auto; width: 40%;height: fit-content;border: none;">
        <fieldset>
            <legend>پست های کاربر</legend>
            <div th:each="post : ${session.userPosts}">

                <div th:if="${session.userPosts.size()>0}"
                     style="margin:auto; width: 100%;height: fit-content;border: groove;">
                    <form action="/user/likePost.do">
                        <input type="text" name="id" th:value="${post.getId()}" readonly hidden> <br/>

                        <a th:href="'/user/getUserPosts.do?userId='+${post.getAuthor().getId()}"
                           th:text="${'نوشته شده توسط :'+post.getAuthor().getUsername().split('@')[0]}"></a><br/>

                        <p th:text="'تاریخ ثبت پست : '+${post.dateAdded}"></p>

                        <p th:text="${post.getText()}" style="white-space: pre-line;overflow-wrap: break-word"></p>

                        <!--if post have image-->
                        <div th:if="${post.isPostHaveImage()}" style="margin: auto">
                            <img th:src="@{${post.getFilePath()}}" style="width: 90%;height: 90%;"/><br/>
                        </div>

                        <!--if post have video-->
                        <div th:if="${post.isPostHaveVideo()}">
                            <video width="90%" height="70%" controls>
                                <source th:src="@{${post.getFilePath()}}" type="video/mp4">
                            </video>
                            <br/>
                        </div>

                        <input type="submit" value="لایک"><br/>
                        <p th:text="'تعداد لایک ها :'+${post.getPostLikes().size()}"></p>
                    </form>

                </div>

            </div>
        </fieldset>
    </div>
</div>

<div th:if="${session.userDetail==null||param.id==null}" style="margin-right:30%;">
    <h2>متاسفیم</h2>
    <h4>خطایی در پردازش درخواست شما رخ داده است</h4><br/>
    <h3>پروفایلی برای کد کاربری مورد نظر یافت نشد</h3>
</div>

</body>
</html>